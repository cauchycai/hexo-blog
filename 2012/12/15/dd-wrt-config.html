<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">刷dd-wrt系统</a></li>
<li><a href="#sec-2">硬盘分区</a></li>
<li><a href="#sec-3">硬盘挂载</a></li>
<li><a href="#sec-4">安装OPKG</a></li>
<li><a href="#sec-5">安装transmission</a></li>
<li><a href="#sec-6">配置启动脚本</a></li>
</ul>
</div>

<h2></div></h2>

<p>layout: post
title: dd-wrt配置记录 - transmission安装
date:  2012-12-16 14:36 +0800
tags: [配置,路由器]
excerpt: &quot; 1.路由器要刷好dd-wrt系统;
 2.准备一个分好区的硬盘，通过usb连到路由器，分区格式必须是linux可以支持的，比如ext3;
 3.硬盘挂载;
 4.安装OPKG，这是OpenWRT的软件包管理工具;
 5.安装transmission;
 6.增加启动脚本。</p>

<h2>&quot;</h2>

<p>
今年上半年的时候买了个可以刷dd-wrt系统的路由器，另外这个路由器提供了一个usb接口，可以外接硬盘或打印机。把它连上硬盘就可以直接配置成nas服务器了，我就是看中这个。买回来立马刷了dd-wrt，然后连上移动硬盘，开启局域网共享，于是我把电影照片统统拷到这个共享空间上，想看的时候直接访问共享然后打开播放，不再需要时不时插移动硬盘到笔记本上，真是清爽极了啊！然后尝试在路由器上安装transmission这个bt客户端时，却怎么都装不上，找了n久都没找到合适的软件包。积极性被打击到了，然后就放弃了，暂时放弃了，考虑到我也实在没有那么多时间看下载的资源（这半年我连电影都没看过几部）。
</p>

<p>
最近听一个同事又讲起配置路由器支持bt下载，让我又想试试重新配置路由器。
</p>

<p>
这次用了openwrt的软件包来安装transmission。主要步骤是：
</p>

<p>
1.路由器要刷好dd-wrt系统;<br  />
 2.准备一个分好区的硬盘，通过usb连到路由器，分区格式必须是linux可以支持的，比如ext3;<br  />
 3.硬盘挂载;<br  />
 4.安装OPKG，这是OpenWRT的软件包管理工具;<br  />
 5.安装transmission;<br  />
 6.增加启动脚本。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">刷dd-wrt系统</h2>
<div class="outline-text-2" id="text-1">
<p>
这步很简单，不说了。
</p>
</div>

<p></div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">硬盘分区</h2>
<div class="outline-text-2" id="text-2">
<p>
如果用的linux可以用Gparted这个软件，windows可以用硬盘分区大师之类软件。所有分区都设为ext3类型，留一个分区给系统装软件用，大小1G～4G，用来放安装的软件，因为路由器的rom只有64M。
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">硬盘挂载</h2>
<div class="outline-text-2" id="text-3">
<p>
在dd-wrt路由器的web设置界面开启jffs2文件系统支持，ssh连接支持，usb挂载支持，并选择自动挂载到/mnt。通过ssh链接到路由器，密码就是路由器web登录的密码，但是用户名当然得是root。查看下是否有 /jffs 这个目录，系统其他目录都是只读的，只有这个目录下可以写并且重启路由后数据仍保留着。因为系统是只读的所以无法装额外的软件，可以挂载安装路径到 /jffs 下的某个目录，但是jffs只有16M的空间，所以还是单独在硬盘上分了一个区然后挂载到系统上用来存放安装的软件。
</p></p>

<p>
假设硬盘上有两个分区，/dev/sda1 和 /dev/sda2 , 分别挂载到 /jffs/system 和 /jffs/data :
</p>

<pre>
# mkdir /jffs/system; mkdir /jffs/data
# mount -t ext3 /dev/sda1 /jffs/system
# mount -t ext3 /dev/sda2 /jffs/data
</pre>

<p>
/jffs/data目录用来存放文件做网络共享，在dd-wrt的web配置界面找到File sharing下的samba，即可配置windows共享。
</p>

<p>
系统中/etc和/opt分别是配置文件目录和安装软件的目录，把 /etc 和 /opt 文件夹下所有文件分别拷到 /jffs/system/etc 和 /jffs/system/opt ,然后分别挂载这两个目录到 /etc 和 /opt ：
</p>

<pre>
# mkdir /jffs/system/etc; mkdir /jffs/system/opt
# cp -a /etc/* /jffs/system/etc/
# mount -o bind /jffs/system/etc/ /etc/
# mount -o bind /jffs/system/opt/ /opt/
</pre>

<p>
这样/etc和/opt两个目录就有了写的权限了。
</p>

<p></div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">安装OPKG</h2>
<div class="outline-text-2" id="text-4">
<p>
OPKG是用来管理软件包的，就像ubuntu的apt-get和redhat的yum。首先手动下载这个软件，软件包来自这个站点：<a href="http://downloads.openwrt.org/snapshots/trunk/">OpenWRT Project</a> 。
</p></p>

<pre>
# mkdir /jffs/installers; cd /jffs/installers 
# wget http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/opkg_618-3_ar71xx.ipk
</pre>

<p>
安装：
</p>

<pre>
# ipkg install opkg_618-3_ar71xx.ipk
</pre>

<p>
安装opkg依赖的库文件：
</p>

<pre>
# wget http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-rootfs.tar.gz
# cd /jffs/installers; tar xvzf openwrt-ar71xx-generic-rootfs.tar.gz
# cp -Pp /jffs/installers/lib/* /jffs/usr/lib/
</pre>

<p>
将/jffs/usr/lib/ 添加到环境变量“LD<sub>LIBRARY</sub><sub>PATH”中</sub>
</p>

<pre>
# export LD_LIBRARY_PATH=/jffs/usr/lib:$LD_LIBRARY_PATH
</pre>

<p>
把opkg软件的配置文件拷到/etc 并修改：
</p>

<pre>
# cp /jffs/etc/opkg.conf /etc/
# vi /etc/opkg.conf
</pre>

<p>
修改为下面的内容：
</p>

<pre>
src/gz snapshots http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages
dest root /opt
dest ram /tmp
lists_dir ext /opt/var/opkg-lists
option overlay_root /overlay
</pre>

<p>
lists\<sub>dir保存软件包的数据库，占用1</sub>.5M容量，因此还是放在/opt下，要预先创建好/opt/var目录。然后更新和查看软件包信息：
</p>

<pre>
# mkdir /opt/var
# opkg update; opkg list
</pre>

<p></div>
</div></p>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">安装transmission</h2>
<div class="outline-text-2" id="text-5">
<p>
在dd-wrt的web管理界面启用UPnP Configuration下的两个选项。
</p>

<p>
安装软件包,运行并初始化（-f参数）：
</p>

<pre>
# opkg update; opkg install transmission-daemon
# transmission-daemon -f
</pre>

<p>
10秒后按Ctrl+C终止掉transmission-daemon，创建下载目录和配置文件目录：
</p>

<pre>
# mkdir -p /jffs/data/torrents/parts/
# mkdir -p /jffs/data/torrents/config/
# cp /tmp/root/.config/transmission-daemon/settings.json /jffs/data/torrents/config/
</pre>

<p>
transmission-daemon没有cli界面，更没有图形界面，但是可以远程管理。远程管理一种是在路由器上安装transmission-web，然后远程通过浏览器访问管理;另一种不需要安装软件，直接在远程机器上安装remote GUI来管理。在这之前需要将远程访问来源的ip加入配置文件的白名单中，编辑/jffs/data/torrents/config/settings.json,修改rpc-whitelist项。添加了自己电脑的ip之后就可以运行transmission，然后进行管理了。
</p>

<pre>
# transmission-daemon -g /jffs/data/torrents/config
</pre>
</div>

<p></div></p>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">配置启动脚本</h2>
<div class="outline-text-2" id="text-6">
<p>
路由器重启后所有设置被重置，但是可以加启动脚本，在启动脚本里重新执行这些步骤：
</p>

<pre>
#!/bin/sh
sleep 30
umount /dev/sda1
umount /dev/sda2
mount -t ext3 /dev/sda1 /jffs/system
mount -t ext3 /dev/sda2 /jffs/data
mount -o bind /jffs/system/etc/ /etc/
mount -o bind /jffs/system/opt/ /opt/
if [[ -z "`cat /tmp/root/.profile | grep "/jffs/usr/lib:/opt/usr/lib"`" ]]; then
    export TMP=$LD_LIBRARY_PATH                                                
    export LD_LIBRARY_PATH=/jffs/usr/lib:/opt/usr/lib:$TMP                     
    echo "LD_LIBRARY_PATH='/jffs/usr/lib:/opt/usr/lib:$TMP'" >>/tmp/root/.profile
fi
/opt/usr/bin/transmission-daemon -g /jffs/data/torrents/config 
</pre>

<p>
保存为/jffs/etc/startup.sh 。然后在dd-wrt的web管理界面找到startup commands，填入如下内容：
</p>

<pre>
/jffs/etc/startup.sh
</pre>

<p>
重启路由器。这样配置就完成了。
</p>
</div>

<p></div></p>
