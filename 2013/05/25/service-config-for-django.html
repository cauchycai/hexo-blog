<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Django Service Config on CentOS</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Thinking Aloud</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Django Service Config on CentOS</h2>
<p class="meta">25 May 2013</p>

<div class="post">
<p>
Django默认没有安装service启动的脚本，偏偏每次改过都要手动重启manage.py（先从进程中kill掉，再执行启动），如果有多个project需要重启，那就更加麻烦了。
</p>

<p>
在Django官方文档里找了个类似的脚本，但是只支持ubuntu，centos上需要修改。我把修改过的贴下。
</p>

<p>
首先创建文件 /etc/init.d/django-fcg
</p>

<pre>
#! /bin/sh
### BEGIN INIT INFO
# Provides:          FastCGI servers for Django
# Required-Start:    networking
# Required-Stop:     networking
# Default-Start:     2 3 4 5
# Default-Stop:      S 0 1 6
# Short-Description: Start FastCGI servers with Django.
# Description:       Django, in order to operate with FastCGI, must be started
#                    in a very specific way with manage.py. This must be done
#                    for each DJango web server that has to run.
### END INIT INFO
#
# Author:  Guillermo Fernandez Castellanos
#          <guillermo.fernandez.castellanos AT gmail.com>.
#
# Version: @(#)fastcgi 0.1 11-Jan-2007 guillermo.fernandez.castellanos AT gmail.com
#


# Source function library.
. /etc/init.d/functions

#### SERVER SPECIFIC CONFIGURATION
DJANGO_SITES="tools"
SITES_PATH=/www
RUNFILES_PATH=/var/run
HOST=127.0.0.1
PORT_START=8000
RUN_AS=root
FCGI_METHOD=threaded
#### DO NOT CHANGE ANYTHING AFTER THIS LINE!

set -e

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DESC="FastCGI servers"
NAME=$0
SCRIPTNAME=/etc/init.d/$NAME
#
#       Function that starts the daemon/service.
#
d_start()
{
    # Starting all Django FastCGI processes
    PORT=$PORT_START
    for SITE in $DJANGO_SITES
    do
        echo -n ", $SITE"
        if [ -f $RUNFILES_PATH/django-$SITE.pid ]; then
            echo -n " already running"
        else
            daemon     --pidfile $RUNFILES_PATH/django-$SITE.pid --user $RUN_AS \
                       /usr/bin/python $SITES_PATH/$SITE/manage.py runfcgi \
                       host=$HOST port=$PORT \
                         pidfile=$RUNFILES_PATH/django-$SITE.pid
            chmod 400 $RUNFILES_PATH/django-$SITE.pid
        fi
        let "PORT = $PORT + 1"
    done
}

#
#       Function that stops the daemon/service.
#
d_stop() {
    # Killing all Django FastCGI processes running
    for SITE in $DJANGO_SITES
    do
        echo -n ", $SITE"
        killproc -p $RUNFILES_PATH/django-$SITE.pid \
                          || echo -n " not running"
        if [ -f $RUNFILES_PATH/django-$SITE.pid ]; then
           rm -f $RUNFILES_PATH/django-$SITE.pid
        fi
    done
}

ACTION="$1"
case "$ACTION" in
    start)
        echo -n "Starting $DESC: $NAME"
        d_start
        echo "."
        ;;

    stop)
        echo -n "Stopping $DESC: $NAME"
        d_stop
        echo "."
        ;;

    restart|force-reload)
        echo -n "Restarting $DESC: $NAME"
        d_stop
        sleep 1
        d_start
        echo "."
        ;;

    *)
        echo "Usage: $NAME {start|stop|restart|force-reload}" >&2
        exit 3
        ;;
esac

exit 0

</pre>

<p>
然后还需要修改下 /etc/init.d/functions
找到 daemon 函数
然后把其中的 \<sub>\</sub><sub>pids\</sub><sub>var\</sub><sub>run</sub> "$base" "$pid\<sub>file</sub>" 这一行注释掉，如果不这么做服务就会停在这函数上。具体什么问题我没搞清楚，注释掉貌似也没啥问题。
</p>

<p>
之后就可以用 service django-fcgi start 和 service django-fcgi stop 启动和停止服务了。
</p>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                Cauchy Cai<br />
                A Programmer<br />
                cauchy.cai@gmail.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/cauchycai">github.com/cauchycai</a><br />
                <a href="https://twitter.com/cauuuuchy">twitter.com/cauuuuchy</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
